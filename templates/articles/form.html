{% extends "base.html" %}
{% block content %}
{{ form.media }}

<h2>{% if is_edit %}Edit{% else %}Create{% endif %} Article</h2>

<a href="{% url 'article_list' %}{% if is_edit %}{% if article.show_on_homepage %}?homepage=yes{% else %}?homepage=no{% endif %}{% else %}{% if force_homepage %}?homepage=yes{% else %}?homepage=no{% endif %}{% endif %}" class="btn">‚Üê Back to Article</a>

<div class="form-container">

  <form method="post" enctype="multipart/form-data" data-model="article" id="article-form">
    {% csrf_token %}
    
    <!-- Hidden input to track which button was clicked -->
    <input type="hidden" name="action" id="form-action" value="save">

    {% if form.non_field_errors %}
      <div class="error">{{ form.non_field_errors }}</div>
    {% endif %}

    <!-- Title -->
    <div class="form-group">
      {{ form.title.label_tag }}
      {{ form.title }}
      <small class="help-text">{{ form.title.help_text }}</small>
      {% if form.title.errors %}
          <div class="error">{{ form.title.errors }}</div>
      {% endif %}
    </div>

    <!-- Subtitle -->
    <div class="form-group">
      {{ form.subtitle.label_tag }}
      {{ form.subtitle }}
      <small class="help-text">{{ form.subtitle.help_text }}</small>
      {% if form.subtitle.errors %}
          <div class="error">{{ form.subtitle.errors }}</div>
      {% endif %}
    </div>

    <!-- Slug -->
    {% if form.slug %}
    <div class="form-group">
      {{ form.slug.label_tag }}
      {{ form.slug }}
      <small class="help-text">{{ form.slug.help_text }}</small>
      <small id="slug-message" class="help-text"></small>
      {% if form.slug.errors %}
          <div class="error">{{ form.slug.errors }}</div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Image -->
    <div class="form-group">
        {{ form.image.label_tag }}
        {% if form.image.errors %}
            <div class="error">{{ form.image.errors }}</div>
        {% endif %}
        <div class="input-file-container">
            {% if is_edit and article.image %}
                <input type="file" name="image" accept="image/*" id="id_image" data-existing-image="{{ article.image.url }}">
            {% else %}
                {{ form.image }}
            {% endif %}
        </div>
        <small class="help-text">
            Allowed formats: JPG, PNG, GIF, WebP | Max size: 5MB | Max dimensions: 1920x1280px
        </small>

        <div id="imagePreview" class="mt-2">
            <p class="no-image text-muted">No image selected</p>
        </div>

        <input type="hidden" name="remove_image" id="remove_image" value="0">
    </div>

    <!-- Content -->
    <div class="form-group">
      {{ form.content.label_tag }}
      {{ form.content }}
      <a class="btn medium bg-orange mrg5T"
        title="Read More"
        id="readMore"
        href="javascript:void(0);">
            <span class="button-content">Read More</span>
        </a>
      {% if form.content.errors %}
          <div class="error">{{ form.content.errors }}</div>
      {% endif %}
    </div>

    <!-- Show on homepage - Information Only -->
    <div class="form-group">
        <label>Homepage Status:</label>
        <div style="background:#e0f2fe; color:#0369a1; padding:10px; border-radius:4px; border:1px solid #bae6fd;">
            <strong>Note:</strong> 
            {% if is_edit %}
                This article is currently 
                {% if article.show_on_homepage %}
                    <b>published on the Homepage</b>.
                {% else %}
                    <b>NOT on the Homepage</b>.
                {% endif %}
                <br>
                <small>Homepage status cannot be changed during edit. To move articles, use the bulk actions in the article list.</small>
            {% else %}
                This article will be automatically published to the 
                <b>{% if force_homepage %}Homepage{% else %}Not Homepage{% endif %}</b>.
            {% endif %}
        </div>
    </div>

    <!-- Active -->
    <div class="form-group checkbox-group">
        <label for="{{ form.is_active.id_for_label }}">
            {{ form.is_active }} {{ form.is_active.label }}
        </label>
    </div>

    <div class="meta-collapsible-wrapper" style="margin-top: 20px; border: 1px solid #ddd; border-radius: 4px;">
        <button type="button" id="toggleMeta" class="btn-secondary" style="width: 100%; text-align: left; padding: 10px; background: #f8f9fa; border: none; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-weight: bold;">SEO / Meta Information (Optional)</span>
            <span id="metaStatusIcon">‚ñº</span>
        </button>

        <div id="metaContent" style="display: none; padding: 15px; border-top: 1px solid #ddd; background: #fff;">
            
            <!-- Meta Title -->
            <div class="form-group">
                {{ form.meta_title.label_tag }}
                {{ form.meta_title }}
                <small class="help-text">
                    Title for search results. Defaults to Article Title if empty. 
                    <strong><span id="meta-title-counter">100</span> characters remaining</strong>
                </small>
                {% if form.meta_title.errors %}
                    <div class="error">{{ form.meta_title.errors }}</div>
                {% endif %}
            </div>

            <!-- Meta Description -->
            <div class="form-group">
                {{ form.meta_description.label_tag }}
                {{ form.meta_description }}
                <small class="help-text">
                    <strong><span id="meta-desc-counter">160</span> characters remaining</strong>
                </small>
                {% if form.meta_description.errors %}
                    <div class="error">{{ form.meta_description.errors }}</div>
                {% endif %}
            </div>

            <!-- Meta Keywords -->
            <div class="form-group">
                {{ form.meta_keywords.label_tag }}
                {{ form.meta_keywords }}
                <small class="help-text">
                    Comma-separated (e.g. news, technology, django). 
                    <strong><span id="meta-keywords-counter">100</span> characters remaining</strong>
                </small>
                {% if form.meta_keywords.errors %}
                    <div class="error">{{ form.meta_keywords.errors }}</div>
                {% endif %}
            </div>

        </div>
    </div>

    <div style="margin-bottom: 20px;"></div>

    <!-- Actions with 3 Buttons -->
    <div class="form-actions" style="display: flex; gap: 10px; align-items: center;">
      <button type="submit" class="btn" onclick="setFormAction('save')">
          üíæ Save
      </button>
      <button type="submit" class="btn" onclick="setFormAction('save_and_new')" style="background: #10b981;">
          ‚ûï Save & Add Another
      </button>
      <button type="submit" class="btn" onclick="setFormAction('save_and_quit')" style="background: #3b82f6;">
          ‚úì Save & Quit
      </button>
      <a href="{% url 'article_list' %}{% if is_edit %}{% if article.show_on_homepage %}?homepage=yes{% else %}?homepage=no{% endif %}{% else %}{% if force_homepage %}?homepage=yes{% else %}?homepage=no{% endif %}{% endif %}" class="btn-cancel">Cancel</a>
    </div>
  </form>
</div>

<script>
function setFormAction(action) {
    document.getElementById('form-action').value = action;
}
</script>

{% endblock %}