{% extends "base.html" %}
{% block content %}

{# Header row: H2 on left, homepage dropdown next to it, Add Article on far right #}
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
    <div style="display:flex; align-items:center; gap:12px;">
        <h2 style="margin:0;">Articles</h2>

        <form method="get" id="homepage-filter-form" style="margin:0;">
            {% if request.GET.q %}
                <input type="hidden" name="q" value="{{ request.GET.q }}">
            {% endif %}
            {% if request.GET.per_page %}
                <input type="hidden" name="per_page" value="{{ request.GET.per_page }}">
            {% endif %}

            <select name="homepage" onchange="this.form.submit();" style="padding:5px 10px;">
                <option value="no" {% if request.GET.homepage == 'no' or not request.GET.homepage %}selected{% endif %}>
                    Not Homepage
                </option>
                <option value="yes" {% if request.GET.homepage == 'yes' %}selected{% endif %}>
                    Homepage
                </option>
            </select>
        </form>
    </div>

    <a href="{% url 'article_create' %}{% if request.GET.homepage == 'yes' %}?from_homepage=yes{% endif %}" class="btn">
        + Add Article
    </a>
</div>

{# Search on left, Items per page, Status/Delete on right - OUTSIDE the bulk form #}
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
    <div style="display:flex; align-items:center; gap:10px;">
        {# Search #}
        <input type="text" id="article-search"
               placeholder="Search entire database live..."
               value="{{ request.GET.q|default:'' }}"
               style="padding:5px 10px; width:250px;">

        {# Items per page - STANDALONE form #}
        <form method="get" id="per-page-form" style="margin:0;">
            {% if request.GET.q %}
                <input type="hidden" name="q" value="{{ request.GET.q }}">
            {% endif %}
            {% if request.GET.homepage %}
                <input type="hidden" name="homepage" value="{{ request.GET.homepage }}">
            {% endif %}

            <select name="per_page" onchange="this.form.submit();" style="padding:5px 10px;">
                <option value="10" {% if request.GET.per_page == '10' or not request.GET.per_page %}selected{% endif %}>10</option>
                <option value="20" {% if request.GET.per_page == '20' %}selected{% endif %}>20</option>
                <option value="50" {% if request.GET.per_page == '50' %}selected{% endif %}>50</option>
            </select>
        </form>
    </div>

    {# Bulk actions #}
    <div style="display:flex; gap:8px;">
        <button type="button" class="btn btn-cancel" onclick="document.getElementById('bulk-form').querySelector('button[name=action][value=toggle]').click()">Status</button>
        <button type="button" class="btn btn-danger"
                onclick="openDeleteModal('article', null, '/bulk/article/', true)">
            Delete
        </button>
    </div>
</div>

{# NOW the bulk action form wraps only the table #}
<form method="post" action="{% url 'bulk_action' 'article' %}" id="bulk-form">
    {% csrf_token %}

    <table class="log-table">
        <thead>
            <tr>
                <th style="width: 30px;"></th> 
                <th><input type="checkbox" id="select-all"></th>
                <th>Title</th>
                <th>Status</th>
                <th>Homepage</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="sortable-tbody" data-update-url="{% url 'sort' 'article' %}">
            {% for a in articles %}
            <tr data-id="{{ a.id }}">
                <td class="drag-handle" style="cursor: grab; color: #9ca3af;">
                    <i class="fa-solid fa-grip-vertical"></i>
                </td>
                
                <td><input type="checkbox" name="selected_ids" value="{{ a.id }}" class="row-checkbox"> </td>
                
                <td><a href="{% url 'article_edit' a.slug %}">{{ a.title }}</a><br><small>{{ a.slug }}</small></td>
                
                <td id="status-{{ a.id }}" class="{% if a.is_active %}status-active{% else %}status-inactive{% endif %}">
                    {{ a.is_active|yesno:"Active,Inactive" }}
                </td>
                
                <td>
                    {% if a.show_on_homepage %}
                        <span class="badge badge-green">Yes</span>
                    {% else %}
                        <span class="badge badge-gray">No</span>
                    {% endif %}
                </td>
                
                <td class="actions">
                    <span class="status-toggle"
                          data-url="{% url 'toggle_status' 'article' a.id %}"
                          data-target="status-{{ a.id }}"
                          onclick="event.preventDefault(); toggleStatus(this)">
                        <i class="fa-solid {% if a.is_active %}fa-toggle-on{% else %}fa-toggle-off{% endif %}"></i>
                    </span>
                    <a href="{% url 'article_edit' a.slug %}" class="icon edit"><i class="fa-solid fa-pen-to-square"></i></a>
                    <span class="icon delete" 
                        onclick="openDeleteModal('article', '{{ a.title }}', '{% url 'delete_object' 'article' a.id %}', false)">
                        <i class="fa-solid fa-trash"></i>
                    </span>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" style="text-align:center;">No articles found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {# Hidden submit buttons for bulk actions #}
    <button type="submit" name="action" value="toggle" style="display:none;"></button>
</form>

{# Pagination outside the form - ALWAYS SHOW #}
{% if page_obj and page_obj.paginator.num_pages > 1 %}
    {% with request.GET.urlencode as query_params %}
    <div id="pagination-wrapper" class="pagination" style="margin-top: 20px; display: flex; justify-content: center; align-items: center; gap: 8px;">
        {% if page_obj.has_previous %}
            <a href="?{% if query_params %}{{ query_params }}&{% endif %}page={{ page_obj.previous_page_number }}" class="btn">Prev</a>
        {% endif %}

        <span style="color: #6b7280;">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
            <small>({{ page_obj.paginator.count }} total)</small>
        </span>

        {% if page_obj.has_next %}
            <a href="?{% if query_params %}{{ query_params }}&{% endif %}page={{ page_obj.next_page_number }}" class="btn">Next</a>
        {% endif %}
    </div>
    {% endwith %}
{% elif page_obj %}
    <div style="margin-top: 20px; text-align: center; color: #6b7280;">
        <small>{{ page_obj.paginator.count }} result{{ page_obj.paginator.count|pluralize }}</small>
    </div>
{% endif %}



{% endblock %}